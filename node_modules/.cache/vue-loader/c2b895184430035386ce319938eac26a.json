{"remainingRequest":"/Users/yunwisdom/Workspace/jeecg-boot/ant-design-vue-jeecg/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/yunwisdom/Workspace/jeecg-boot/ant-design-vue-jeecg/src/components/jeecgbiz/modal/JSelectUserByDepModal.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/yunwisdom/Workspace/jeecg-boot/ant-design-vue-jeecg/src/components/jeecgbiz/modal/JSelectUserByDepModal.vue","mtime":1571018558901},{"path":"/Users/yunwisdom/Workspace/jeecg-boot/ant-design-vue-jeecg/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/yunwisdom/Workspace/jeecg-boot/ant-design-vue-jeecg/node_modules/thread-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/yunwisdom/Workspace/jeecg-boot/ant-design-vue-jeecg/node_modules/@vue/cli-plugin-babel/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/yunwisdom/Workspace/jeecg-boot/ant-design-vue-jeecg/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/yunwisdom/Workspace/jeecg-boot/ant-design-vue-jeecg/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { filterObj } from '@/utils/util'\nimport { queryDepartTreeList, getUserList, queryUserByDepId, queryUserRoleMap } from '@/api/api'\nexport default {\n  name: 'JSelectUserByDepModal',\n  components: {},\n  props:['modalWidth'],\n  data() {\n    return {\n      queryParam: {\n        username:\"\",\n      },\n      columns: [\n        {\n          title: '用户账号',\n          align: 'center',\n          dataIndex: 'username'\n        },\n        {\n          title: '真实姓名',\n          align: 'center',\n          dataIndex: 'realname'\n        },\n        {\n          title: '角色名称',\n          align: 'center',\n          dataIndex: 'roleName'\n        },\n        {\n          title: '性别',\n          align: 'center',\n          dataIndex: 'sex',\n          customRender: function(text) {\n            if (text === 1) {\n              return '男'\n            } else if (text === 2) {\n              return '女'\n            } else {\n              return text\n            }\n          }\n        },\n        {\n          title: '手机号码',\n          align: 'center',\n          dataIndex: 'phone'\n        },\n        {\n          title: '邮箱',\n          align: 'center',\n          dataIndex: 'email'\n        }\n      ],\n      scrollTrigger: {},\n      dataSource: [],\n      selectedKeys: [],\n      userNameArr: [],\n      departName: '',\n      userRolesMap: {},\n      title: '根据部门选择用户',\n      ipagination: {\n        current: 1,\n        pageSize: 10,\n        pageSizeOptions: ['10', '20', '30'],\n        showTotal: (total, range) => {\n          return range[0] + '-' + range[1] + ' 共' + total + '条'\n        },\n        showQuickJumper: true,\n        showSizeChanger: true,\n        total: 0\n      },\n      isorter: {\n        column: 'createTime',\n        order: 'desc'\n      },\n      selectedRowKeys: [],\n      selectedRows: [],\n      departTree: [],\n      visible: false,\n      form: this.$form.createForm(this)\n    }\n  },\n  created() {\n    // 该方法触发屏幕自适应\n    this.resetScreenSize();\n    this.queryUserRoleMap();\n  },\n  methods: {\n    loadData(arg) {\n      if (arg === 1) {\n        this.ipagination.current = 1;\n      }\n      let params = this.getQueryParams();//查询条件\n      getUserList(params).then((res) => {\n        if (res.success) {\n          this.dataSource = res.result.records;\n          this.assignRoleName(this.dataSource);\n          this.ipagination.total = res.result.total;\n        }\n      })\n    },\n    queryUserRoleMap(){\n      queryUserRoleMap().then((res) => {\n        if (res.success) {\n          this.userRolesMap = res.result;\n          this.loadData();\n        }\n      })\n    },\n    // 触发屏幕自适应\n    resetScreenSize() {\n      let screenWidth = document.body.clientWidth;\n      if (screenWidth < 500) {\n        this.scrollTrigger = { x: 800 };\n      } else {\n        this.scrollTrigger = {};\n      }\n    },\n    showModal() {\n      this.visible = true;\n      this.assignRoleName(this.dataSource);\n      this.queryDepartTree();\n      this.form.resetFields();\n    },\n    getQueryParams() {\n      let param = Object.assign({}, this.queryParam, this.isorter);\n      param.field = this.getQueryField();\n      param.pageNo = this.ipagination.current;\n      param.pageSize = this.ipagination.pageSize;\n      return filterObj(param);\n    },\n    getQueryField() {\n      let str = 'id,';\n      for (let a = 0; a < this.columns.length; a++) {\n        str += ',' + this.columns[a].dataIndex;\n      }\n      return str;\n    },\n    searchReset(num) {\n      let that = this;\n      if(num !== 0){\n        that.queryParam = {};\n        that.loadData(1);\n      }\n      that.selectedRowKeys = [];\n      that.userNameArr = [];\n      that.selectedKeys = [];\n    },\n    close() {\n      this.searchReset(0);\n      this.visible = false;\n    },\n    handleTableChange(pagination, filters, sorter) {\n      //TODO 筛选\n      if (Object.keys(sorter).length > 0) {\n        this.isorter.column = sorter.field;\n        this.isorter.order = 'ascend' === sorter.order ? 'asc' : 'desc';\n      }\n      this.ipagination = pagination;\n      this.loadData();\n    },\n    handleSubmit() {\n      let that = this;\n      for (let i = 0, len = this.selectedRowKeys.length; i < len; i++) {\n        this.getUserNames(this.selectedRowKeys[i]);\n      }\n      that.$emit('ok', that.userNameArr.join(','));\n      that.close();\n    },\n    // 遍历匹配,获取用户真实姓名\n    getUserNames(rowId) {\n      let dataSource = this.dataSource;\n      for (let i = 0, len = dataSource.length; i < len; i++) {\n        if (rowId === dataSource[i].id) {\n          this.userNameArr.push(dataSource[i].realname);\n        }\n      }\n    },\n    // 点击树节点,筛选出对应的用户\n    onSelect(selectedKeys) {\n      if (selectedKeys[0] != null) {\n        this.queryUserByDepId(selectedKeys); // 调用方法根据选选择的id查询用户信息\n        if (this.selectedKeys[0] !== selectedKeys[0]) {\n          this.selectedKeys = [selectedKeys[0]];\n        }\n      }\n    },\n    onSelectChange(selectedRowKeys, selectionRows) {\n      this.selectedRowKeys = selectedRowKeys;\n      this.selectionRows = selectionRows;\n    },\n    onSearch() {\n      this.loadData(1);\n    },\n    // 根据选择的id来查询用户信息\n    queryUserByDepId(selectedKeys) {\n      queryUserByDepId({ id: selectedKeys.toString() }).then((res) => {\n        if (res.success) {\n          this.dataSource = res.result;\n          this.ipagination.total = res.result.length;\n          this.assignRoleName(this.dataSource);\n        }\n      })\n    },\n    // 传入用户id,找到匹配的角色名称\n    queryUserRole(userId) {\n      let map = this.userRolesMap;\n      let roleName = [];\n      for (var key in map) {\n        if (userId === key) {\n          roleName.push(map[key]);\n        }\n      }\n      return roleName.join(',');\n    },\n    queryDepartTree() {\n      queryDepartTreeList().then((res) => {\n        if (res.success) {\n          this.departTree = res.result;\n        }\n      })\n    },\n    // 为角色名称赋值\n    assignRoleName(data) {\n      let userId = '';\n      let role = '';\n      for (let i = 0, length = data.length; i < length; i++) {\n        userId = this.dataSource[i].id;\n        role = this.queryUserRole(userId);\n        this.dataSource[i].roleName = role;\n      }\n    },\n    modalFormOk() {\n      this.loadData();\n    }\n  }\n}\n",null]}